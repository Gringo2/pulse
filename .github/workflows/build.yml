name: Pulse Continuous Integration

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  verify:
    name: Verify Compilation
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build (iOS Simulator)
        id: build
        run: |
          xcodebuild build \
            -scheme Pulse \
            -destination "generic/platform=iOS Simulator" \
            -sdk iphonesimulator \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO
          
          # Export build settings to find the executable path
          xcodebuild -scheme Pulse -destination "generic/platform=iOS Simulator" -sdk iphonesimulator -derivedDataPath ./build -showBuildSettings > settings.txt
          echo "EXECUTABLE_PATH=$(grep -m 1 " EXECUTABLE_PATH = " settings.txt | cut -d'=' -f2 | xargs)" >> $GITHUB_ENV
          echo "CODESIGNING_FOLDER_PATH=$(grep -m 1 " CODESIGNING_FOLDER_PATH = " settings.txt | cut -d'=' -f2 | xargs)" >> $GITHUB_ENV

      - name: Package Artifact (Pulse.app.zip)
        run: |
          mkdir -p Payload
          
          # Strategy 1: Check if xcodebuild produced a .app folder already (unlikely for raw SPM)
          if [ -d "$CODESIGNING_FOLDER_PATH" ]; then
            echo "Found .app folder at $CODESIGNING_FOLDER_PATH"
            cp -r "$CODESIGNING_FOLDER_PATH" Payload/
          else
            # Strategy 2: Manual bundling from binary
            echo "Creating manual .app bundle..."
            # Find the actual Mach-O binary named Pulse
            BINARY_PATH=$(find build -name "Pulse" -type f | xargs file | grep "Mach-O" | cut -d: -f1 | head -n 1)
            if [ -z "$BINARY_PATH" ]; then
                echo "ERROR: Could not find Mach-O binary 'Pulse' in build directory"
                find build -maxdepth 5
                exit 1
            fi
            echo "Found binary at: $BINARY_PATH"
            mkdir -p Payload/Pulse.app
            cp "$BINARY_PATH" Payload/Pulse.app/Pulse
            
            # Create a minimal Info.plist
            cat <<EOF > Payload/Pulse.app/Info.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Pulse</string>
              <key>CFBundleIdentifier</key>
              <string>com.pulse.app</string>
              <key>CFBundleName</key>
              <string>Pulse</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSRequiresIPhoneOS</key>
              <true/>
          </dict>
          </plist>
          EOF
          fi
          
          zip -r Pulse.app.zip Payload
          
      - name: Upload Pulse.app.zip
        uses: actions/upload-artifact@v4
        with:
          name: Pulse.app.zip
          path: Pulse.app.zip
          retention-days: 7
