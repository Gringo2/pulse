name: Pulse CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Build for the iOS Simulator (Allows testing on Mac desktops)
  simulator:
    runs-on: macos-latest
    permissions:
      contents: write
    outputs:
      app_version: ${{ steps.meta.outputs.app_version }}
      build_number: ${{ steps.meta.outputs.build_number }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Safety: Clean up disk space. macOS runners are often >90% full.
      # Removing unused Xcode versions and Android tools prevents build failure.
      - name: Free up disk space
        run: |
          sudo rm -rf /Applications/Xcode_15*.app || true
          sudo rm -rf /Applications/Xcode_14*.app || true
          sudo rm -rf ~/Library/Android || true
          sudo rm -rf /usr/local/Homebrew/Library/Taps || true

      # Robust Xcode selection based on versions.json
      - name: Set active Xcode path
        id: xcode
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          if [ -d "/Applications/Xcode_$XCODE_VERSION.app" ]; then
            sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer
          fi
          xcodebuild -version

      # Extract metadata for Release notes
      - name: Extract Metadata
        id: meta
        run: |
          VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["app"]);')
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV

      # Primary Build: Compiles for Simulator
      - name: Build (iOS Simulator)
        run: |
          xcodebuild build \
            -scheme Pulse \
            -configuration Debug \
            -destination "generic/platform=iOS Simulator" \
            -sdk iphonesimulator \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO

      # Packaging: SPM projects often need manual Info.plist assembly
      - name: Package Simulator Artifact
        run: |
          mkdir -p Payload/Pulse.app
          # Find the compiled binary
          BINARY_PATH=$(find build -name "Pulse" -type f | xargs file | grep "Mach-O" | cut -d: -f1 | head -n 1)
          cp "$BINARY_PATH" Payload/Pulse.app/Pulse
          
          # Find and copy Assets.car (Icon/Assets)
          ASSETS_CAR=$(find build -name "Assets.car" -type f | head -n 1)
          if [ -n "$ASSETS_CAR" ]; then cp "$ASSETS_CAR" Payload/Pulse.app/; fi
          
          # Find resource bundles and copy contents to root for UIImage(named:) compatibility
          find build -name "*.bundle" -type d -exec cp -r "{}/." Payload/Pulse.app/ \;
          
          # Manually create Info.plist for the bundle
          echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>CFBundleExecutable</key><string>Pulse</string><key>CFBundleIdentifier</key><string>com.pulse.app</string><key>CFBundleName</key><string>Pulse</string><key>CFBundlePackageType</key><string>APPL</string><key>CFBundleShortVersionString</key><string>${{ env.APP_VERSION }}</string><key>CFBundleVersion</key><string>${{ env.BUILD_NUMBER }}</string><key>LSRequiresIPhoneOS</key><true/><key>UILaunchScreen</key><dict/></dict></plist>' > Payload/Pulse.app/Info.plist
          
          zip -r Pulse-Simulator.app.zip Payload

      - name: Upload Simulator Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pulse-Simulator
          path: Pulse-Simulator.app.zip

  # Job 2: Build for Real Devices (Allows sideloading via Sideloadly)
  device:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Safety cleanup (Restored because it was removed in previous failed iteration)
      - name: Free up disk space
        run: |
          sudo rm -rf /Applications/Xcode_15*.app || true
          sudo rm -rf ~/Library/Android || true

      # Restored robust Xcode selection (Removed fallback in previous failed iteration)
      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          if [ -d "/Applications/Xcode_$XCODE_VERSION.app" ]; then
            sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer
          fi

      - name: Build (iOS Device)
        run: |
          xcodebuild build \
            -scheme Pulse \
            -configuration Debug \
            -destination "generic/platform=iOS" \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            ENTITLEMENTS_ALLOWED=NO

      # Package as .ipa for sideloading
      - name: Package IPA
        run: |
          mkdir -p Payload/Pulse.app
          # FIX: Use case-insensitive grep for 'arm64' to ensure binary is found on runner
          BINARY_PATH=$(find build -name "Pulse" -type f | xargs file | grep -i "arm64" | cut -d: -f1 | head -n 1)
          if [ -z "$BINARY_PATH" ]; then
            echo "Fallback: Trying Mach-O search..."
            BINARY_PATH=$(find build/Build/Products/Debug-iphoneos -name "Pulse" -type f | head -n 1)
          fi
          
          if [ -z "$BINARY_PATH" ]; then
             echo "Error: Binary not found at expected location."
             exit 1
          fi
          
          cp "$BINARY_PATH" Payload/Pulse.app/Pulse
          
          # Find and copy Assets.car
          ASSETS_CAR=$(find build -name "Assets.car" -type f | head -n 1)
          if [ -n "$ASSETS_CAR" ]; then cp "$ASSETS_CAR" Payload/Pulse.app/; fi
          
          # Find resource bundles and copy contents to root for UIImage(named:) compatibility
          find build -name "*.bundle" -type d -exec cp -r "{}/." Payload/Pulse.app/ \;
          
          # Use fixed version string to avoid environment issues in subshells
          VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["app"]);')
          echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>CFBundleExecutable</key><string>Pulse</string><key>CFBundleIdentifier</key><string>com.pulse.app</string><key>CFBundleName</key><string>Pulse</string><key>CFBundlePackageType</key><string>APPL</string><key>CFBundleShortVersionString</key><string>'$VERSION'</string><key>CFBundleVersion</key><string>${{ github.run_number }}</string><key>LSRequiresIPhoneOS</key><true/><key>UILaunchScreen</key><dict/></dict></plist>' > Payload/Pulse.app/Info.plist
          
          zip -r Pulse.ipa Payload

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pulse-IPA
          path: Pulse.ipa

  # Job 3: Create the GitHub Release once both builds are finished
  release:
    needs: [simulator, device]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ needs.simulator.outputs.build_number }}
          name: Pulse ${{ needs.simulator.outputs.app_version }} (Build ${{ needs.simulator.outputs.build_number }})
          body: |
            Pulse Dual Artifact Release
            - Simulator (Mac): Pulse-Simulator.app.zip
            - Real Device (iPhone): Pulse.ipa (Use Sideloadly to install)
          files: |
            Pulse-Simulator.app.zip
            Pulse.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
