name: Pulse CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  simulator:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer
          xcodebuild -version

      - name: Build (iOS Simulator)
        run: |
          xcodebuild build \
            -scheme Pulse \
            -configuration Debug \
            -destination "generic/platform=iOS Simulator" \
            -sdk iphonesimulator \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO

      - name: Package Simulator Artifact
        run: |
          mkdir -p Payload
          APP_PATH=$(find build -name "Pulse.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: Pulse.app not found"
            exit 1
          fi
          cp -r "$APP_PATH" Payload/
          zip -r Pulse-Simulator.app.zip Payload

      - name: Upload Simulator Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pulse-Simulator
          path: Pulse-Simulator.app.zip

  device:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set active Xcode path
        run: |
          XCODE_VERSION=$(cat versions.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["xcode"]);')
          sudo xcode-select -s /Applications/Xcode_$XCODE_VERSION.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_16.app/Contents/Developer

      - name: Build (iOS Device)
        run: |
          xcodebuild build \
            -scheme Pulse \
            -configuration Debug \
            -destination "generic/platform=iOS" \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            ENTITLEMENTS_ALLOWED=NO

      - name: Package IPA
        run: |
          mkdir -p Payload
          APP_PATH=$(find build -name "Pulse.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Error: Pulse.app not found"
            exit 1
          fi
          cp -r "$APP_PATH" Payload/
          zip -r Pulse.ipa Payload

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pulse-IPA
          path: Pulse.ipa

  release:
    needs: [simulator, device]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Pulse Build ${{ github.run_number }}
          files: |
            Pulse-Simulator.app.zip
            Pulse.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
